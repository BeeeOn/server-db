[beeeon]
gateways.create           = INSERT INTO beeeon.gateways (id, name, altitude, latitude, longitude, timezone) VALUES ($1::bigint, $2::varchar, $3::integer, $4::double precision, $5::double precision, $6::varchar(64))
gateways.fetch.by.id      = SELECT g.id AS id, g.name AS name, g.altitude AS altitude, g.latitude AS latitude, g.longitude AS longitude, g.timezone AS timezone, extract(epoch from s.at)::bigint AS last_changed, s.version AS version, host(s.ip)::varchar(45) AS ip FROM beeeon.gateways AS g LEFT JOIN beeeon.gateways_status AS s ON g.id = s.gateway_id WHERE g.id = $1::bigint AND (s.at IS NULL OR s.at = beeeon.gateways_status_most_recent(g.id)) LIMIT 1
gateways.update           = UPDATE beeeon.gateways SET name = $2::varchar, altitude = $3::integer, latitude = $4::double precision, longitude = $5::double precision, timezone = $6::varchar(64) WHERE id = $1::bigint
gateways.fetch.accessible = SELECT DISTINCT g.id AS id, g.name AS name, g.altitude AS altitude, g.latitude AS latitude, g.longitude AS longitude, g.timezone AS timezone, extract(epoch from s.at)::bigint AS last_changed, s.version AS version, host(s.ip)::varchar(45) AS ip FROM beeeon.gateways AS g JOIN beeeon.roles_in_gateway AS r ON g.id = r.gateway_id JOIN beeeon.verified_identities AS v ON v.identity_id = r.identity_id LEFT JOIN beeeon.gateways_status AS s ON s.gateway_id = g.id WHERE v.user_id = $1::uuid AND (s.at IS NULL OR s.at = beeeon.gateways_status_most_recent(g.id))
gateways_status.insert    = WITH input AS (SELECT $1::bigint AS gateway_id, beeeon.as_utc_timestamp($2) AS at, $3::varchar(40) AS version, $4::inet AS ip), status AS (SELECT count(*) > 0 AS same FROM beeeon.gateways_status AS s, input WHERE s.gateway_id = input.gateway_id AND s.version = input.version AND s.ip = input.ip AND s.at = beeeon.gateways_status_most_recent(input.gateway_id)) INSERT INTO beeeon.gateways_status (gateway_id, at, version, ip) SELECT input.gateway_id, input.at, input.version, input.ip FROM input, status WHERE NOT status.same

locations.create          = INSERT INTO beeeon.locations (id, name, gateway_id) VALUES ($1::uuid, $2::varchar, $3::bigint)
locations.fetch.by.id     = SELECT id, name, gateway_id FROM beeeon.locations WHERE id = $1 LIMIT 1
locations.fetch.by.gateway_id = SELECT id, name, gateway_id FROM beeeon.locations WHERE gateway_id = $1::bigint
locations.fetch.by.id.and.gateway_id = SELECT id, name, gateway_id FROM beeeon.locations WHERE id = $1::uuid AND gateway_id = $2::bigint
locations.update          = UPDATE beeeon.locations SET name = $2 WHERE id = $1
locations.remove          = DELETE FROM beeeon.locations WHERE id = $1

users.create              = INSERT INTO beeeon.users (id, first_name, last_name, locale) VALUES ($1::uuid, $2::varchar, $3::varchar, $4::varchar)
users.fetch.by.id         = SELECT id, first_name, last_name, locale FROM beeeon.users WHERE id = $1 LIMIT 1

fcm_tokens.create           = INSERT INTO beeeon.fcm_tokens (token, user_id) VALUES ($1, $2)
fcm_tokens.remove           = DELETE FROM beeeon.fcm_tokens WHERE token = $1
fcm_tokens.replace          = WITH input AS (SELECT $1 AS token_from, $2 AS token_to), do_insert AS (INSERT INTO beeeon.fcm_tokens SELECT input.token_to, user_id FROM beeeon.fcm_tokens, input WHERE token = input.token_from) DELETE FROM beeeon.fcm_tokens WHERE token IN (SELECT token_from FROM input)
fcm_tokens.fetch.by.id      = SELECT t.token AS token, u.id AS user_id, u.first_name AS user_first_name, u.last_name AS user_last_name, u.locale AS user_locale FROM beeeon.fcm_tokens AS t JOIN beeeon.users AS u ON t.user_id = u.id WHERE t.token = $1 LIMIT 1
fcm_tokens.fetch.by.user.id = SELECT token, user_id FROM beeeon.fcm_tokens WHERE user_id = $1
fcm_recipients.by_gateway   = SELECT t.token AS token, t.user_id AS user_id, u.first_name AS user_first_name, u.last_name AS user_last_name, u.locale AS user_locale FROM beeeon.fcm_tokens AS t JOIN beeeon.verified_identities AS v ON t.user_id = v.user_id JOIN beeeon.roles_in_gateway AS r ON r.identity_id = v.identity_id JOIN beeeon.users AS u ON u.id = t.user_id WHERE r.gateway_id = $1

identities.create         = INSERT INTO beeeon.identities (id, email) VALUES ($1, $2)
identities.fetch.by.id    = SELECT * FROM beeeon.identities WHERE id = $1
identities.fetch.by.email = SELECT id, email FROM beeeon.identities WHERE email = $1 LIMIT 1
identities.remove         = DELETE FROM beeeon.identities WHERE id = $1

verified_identities.create         = INSERT INTO beeeon.verified_identities (id, identity_id, user_id, provider, picture, access_token) VALUES ($1, $2, $3, $4, $5, $6)
verified_identities.fetch.by.id    = SELECT v.id AS id, v.identity_id AS identity_id, v.user_id AS user_id, v.provider AS provider, v.picture AS picture, v.access_token AS access_token, i.email AS identity_email, u.first_name AS user_first_name, u.last_name AS user_last_name FROM beeeon.verified_identities AS v JOIN beeeon.identities AS i ON v.identity_id = i.id JOIN beeeon.users AS u ON v.user_id = u.id WHERE v.id = $1 LIMIT 1
verified_identities.fetch.by.email.and.provider = SELECT v.id AS id, v.identity_id AS identity_id, v.user_id AS user_id, v.provider AS provider, v.picture AS picture, v.access_token AS access_token, i.email AS identity_email, u.first_name AS user_first_name, u.last_name AS user_last_name FROM beeeon.verified_identities AS v JOIN beeeon.identities AS i ON v.identity_id = i.id JOIN beeeon.users AS u ON v.user_id = u.id WHERE i.email = $1 AND v.provider = $2 LIMIT 1
verified_identities.fetch.by.email = SELECT v.id AS id, v.identity_id AS identity_id, v.user_id AS user_id, v.provider AS provider, v.picture AS picture, v.access_token AS access_token, i.email AS identity_email, u.first_name AS user_first_name, u.last_name AS user_last_name FROM beeeon.verified_identities AS v JOIN beeeon.identities AS i ON v.identity_id = i.id JOIN beeeon.users AS u ON v.user_id = u.id WHERE i.email = $1 ORDER BY provider
verified_identities.fetch.by.user  = SELECT v.id AS id, v.identity_id AS identity_id, v.user_id AS user_id, v.provider AS provider, v.picture AS picture, v.access_token AS access_token, i.email AS identity_email, u.first_name AS user_first_name, u.last_name AS user_last_name FROM beeeon.verified_identities AS v JOIN beeeon.identities AS i ON v.identity_id = i.id JOIN beeeon.users AS u ON v.user_id = u.id WHERE u.id = $1 ORDER BY provider, id
verified_identities.update         = UPDATE beeeon.verified_identities SET picture = $2, access_token = $3 WHERE id = $1
verified_identities.remove         = DELETE FROM beeeon.verified_identities WHERE id = $1

roles_in_gateway.create              = SELECT beeeon.roles_in_gateway_insert($1::uuid, $2::bigint, $3::uuid, $4::integer, $5::bigint)
roles_in_gateway.update              = SELECT beeeon.roles_in_gateway_update($1::uuid, $2::integer)
roles_in_gateway.fetch.by.id         = SELECT * FROM beeeon.roles_in_gateway_by_id($1::uuid)
roles_in_gateway.fetch.by.gateway_id = SELECT * FROM beeeon.roles_in_gateway_by_gateway($1::bigint)
roles_in_gateway.remove              = SELECT beeeon.roles_in_gateway_remove($1::uuid)
roles_in_gateway.remove.user         = SELECT beeeon.roles_in_gateway_remove_user($1::uuid, $2::bigint)
roles_in_gateway.remove.all          = SELECT beeeon.roles_in_gateway_remove_gateway_all($1::bigint)
roles_in_gateway.is.user             = SELECT beeeon.roles_in_gateway_is_user($1::uuid, $2::uuid)
roles_in_gateway.is.registered       = SELECT beeeon.roles_in_gateway_is_registered($1::bigint)
roles_in_gateway.has.only.given.level.except = SELECT beeeon.roles_in_gateway_has_only_given_level_except($1::integer, $2::bigint, $3::uuid)
roles_in_gateway.can.see.identity = SELECT beeeon.roles_in_gateway_can_see_identity($1::uuid, $2::uuid)
roles_in_gateway.can.see.verified_identity = SELECT beeeon.roles_in_gateway_can_see_verified_identity($1::uuid, $2::uuid)
roles_in_gateway.fetch.access_level  = SELECT beeeon.roles_in_gateway_access_level($1::bigint, $2::uuid)
roles_in_gateway.fetch.accessible.gateways = SELECT * FROM beeeon.roles_in_gateway_accessible_gateways($1::integer, $2::uuid)

legacy_roles_in_gateway.fetch.by.id = SELECT * FROM beeeon.legacy_roles_in_gateway_by_id($1::uuid)
legacy_roles_in_gateway.fetch.by.gateway_id = SELECT * FROM beeeon.legacy_roles_in_gateway_by_gateway($1::bigint)

legacy_gateways.fetch.by.id = SELECT g.id AS id, g.name AS name, g.altitude AS altitude, g.latitude AS latitude, g.longitude AS longitude, g.timezone AS timezone, extract(epoch from s.at)::bigint AS last_changed, s.version AS version, host(s.ip)::varchar(45) AS ip, g.roles_count AS roles_count, g.devices_count AS devices_count, g.owner_id AS owner_id, o.first_name AS owner_first_name, o.last_name AS owner_last_name, (SELECT level FROM beeeon.users_of_gateway WHERE gateway_id = g.id AND user_id = $1) AS access_level FROM beeeon.legacy_gateways AS g LEFT JOIN beeeon.gateways_status AS s ON s.gateway_id = g.id LEFT JOIN beeeon.users AS o ON o.id = g.owner_id WHERE g.id = $2 AND (s.at IS NULL OR s.at = beeeon.gateways_status_most_recent(g.id)) LIMIT 1
legacy_gateways.fetch.accessible = SELECT DISTINCT g.id AS id, g.name AS name, g.altitude AS altitude, g.latitude AS latitude, g.longitude AS longitude, g.timezone AS timezone, extract(epoch from s.at)::bigint AS last_changed, s.version AS version, host(s.ip)::varchar(45) AS ip, g.roles_count AS roles_count, g.devices_count AS devices_count, g.owner_id AS owner_id, o.first_name AS owner_first_name, o.last_name AS owner_last_name, u.level AS access_level FROM beeeon.legacy_gateways AS g JOIN beeeon.users_of_gateway AS u ON u.gateway_id = g.id LEFT JOIN beeeon.gateways_status AS s ON s.gateway_id = g.id LEFT JOIN beeeon.users AS o ON o.id = g.owner_id WHERE u.user_id = $1 AND (s.at IS NULL OR s.at = beeeon.gateways_status_most_recent(g.id))

devices.create             = INSERT INTO beeeon.devices (id, gateway_id, location_id, name, type, refresh, battery, signal, first_seen, last_seen, active_since) VALUES (beeeon.to_device_id($1), $2, $3, $4, $5, $6, $7, $8, beeeon.as_utc_timestamp($9), beeeon.as_utc_timestamp($10), beeeon.as_utc_timestamp($11))
devices.update             = UPDATE beeeon.devices SET location_id = $1, name = $2, type = $3, refresh = $4, battery = $5, signal = $6, last_seen = NOW(), active_since = beeeon.as_utc_timestamp($7) WHERE id = beeeon.to_device_id($8) AND gateway_id = $9
devices.fetch.from.gateway = SELECT beeeon.from_device_id(id) AS id, gateway_id AS gateway_id, location_id AS location_id, name AS name, type AS type, refresh AS refresh, battery AS battery, signal AS signal, extract(epoch FROM first_seen)::bigint AS first_seen, extract(epoch FROM last_seen)::bigint AS last_seen, extract(epoch FROM active_since)::bigint AS active_since FROM beeeon.devices WHERE id = beeeon.to_device_id($1) AND gateway_id = $2 LIMIT 1
devices.fetch.active.by.gateway   = SELECT beeeon.from_device_id(id) AS id, gateway_id AS gateway_id, location_id AS location_id, name AS name, type AS type, refresh AS refresh, battery AS battery, signal AS signal, extract(epoch FROM first_seen)::bigint AS first_seen, extract(epoch FROM last_seen)::bigint AS last_seen, extract(epoch FROM active_since)::bigint AS active_since FROM beeeon.devices WHERE active_since IS NOT NULL AND gateway_id = $1
devices.fetch.inactive.by.gateway = SELECT beeeon.from_device_id(id) AS id, gateway_id AS gateway_id, location_id AS location_id, name AS name, type AS type, refresh AS refresh, battery AS battery, signal AS signal, extract(epoch FROM first_seen)::bigint AS first_seen, extract(epoch FROM last_seen)::bigint AS last_seen, NULL::bigint AS active_since FROM beeeon.devices WHERE active_since IS NULL AND gateway_id = $1
devices.fetch.active.by.gateway.with.prefix = SELECT beeeon.from_device_id(id) AS id, gateway_id AS gateway_id, location_id AS location_id, name AS name, type AS type, refresh AS refresh, battery AS battery, signal AS signal, extract(epoch FROM first_seen)::bigint AS first_seen, extract(epoch FROM last_seen)::bigint AS last_seen, extract(epoch FROM active_since)::bigint AS active_since FROM beeeon.devices WHERE id >= beeeon.to_device_id($2) AND id <= beeeon.to_device_id($3) AND active_since IS NOT NULL AND gateway_id = $1;

devices_properties.insert  = INSERT INTO beeeon.device_properties(device_id, gateway_id, key, value, params) VALUES (beeeon.to_device_id($1), $2, $3, $4, $5)
devices_properties.update  = UPDATE beeeon.device_properties SET value = $1, params = $2 WHERE device_id = beeeon.to_device_id($3) AND gateway_id = $4 AND key = $5
devices_properties.remove  = DELETE FROM beeeon.device_properties WHERE device_id = beeeon.to_device_id($1) AND gateway_id = $2 AND key = $3
devices_properties.fetch   = SELECT * FROM beeeon.device_properties_by_key($1::numeric, $2::bigint, $3::smallint)
devices_properties.fetch.by.device = SELECT * FROM beeeon.device_properties_by_device($1::numeric, $2::bigint)

sensors_history.insert = SELECT beeeon.sensor_history_recent_insert($1::bigint, beeeon.to_device_id($2::numeric(20, 0)), $3::smallint, beeeon.as_utc_timestamp_us($4), $5)
sensors_history.fetch = SELECT extract(epoch FROM at)::bigint, value FROM beeeon.sensor_history_last WHERE gateway_id = $1 AND device_id = beeeon.to_device_id($2) AND module_id = $3
sensors_history.fetch.huge.interval = SELECT * FROM beeeon.sensor_history_recent_aggregate($1::bigint, $2::numeric(20, 0), $3::smallint, $4::bigint, $5::bigint, $6::bigint)

controls_fsm.insert_request = INSERT INTO beeeon.controls_fsm (gateway_id, device_id, module_id, value, requested_at, accepted_at, finished_at, failed, originator_user_id) VALUES ($1::bigint, beeeon.to_device_id($2::numeric(20, 0)), $3::smallint, $4::real, beeeon.as_utc_timestamp_us($5), beeeon.as_utc_timestamp_us($6), beeeon.as_utc_timestamp_us($7), $8::boolean, $9::uuid)
controls_fsm.update_request = UPDATE beeeon.controls_fsm SET accepted_at = beeeon.as_utc_timestamp_us($1), finished_at = beeeon.as_utc_timestamp_us($2), failed = $3::boolean WHERE gateway_id = $4::bigint AND device_id = beeeon.to_device_id($5::numeric(20, 0)) AND module_id = $6 AND requested_at = beeeon.as_utc_timestamp_us($7)
controls_fsm.fetch_last = SELECT f.value as requested_value, (extract(epoch from f.requested_at) * 1000000)::bigint AS requested_at, (extract(epoch from f.accepted_at) * 1000000)::bigint AS accepted_at, (extract(epoch from f.finished_at) * 1000000)::bigint AS finished_at, f.failed AS failed, f.originator_user_id AS originator_user_id, (extract(epoch from r.at) * 1000000)::bigint AS recent_at, r.value AS recent_value FROM beeeon.controls_fsm_last f FULL OUTER JOIN beeeon.sensor_history_last r ON f.gateway_id = r.gateway_id AND f.device_id = r.device_id AND f.module_id = r.module_id WHERE f.gateway_id = $1::bigint AND f.device_id = beeeon.to_device_id($2) AND f.module_id = $3::smallint
controls_fsm.cancel_unfinished = UPDATE beeeon.controls_fsm SET finished_at = NOW(), failed = true WHERE finished_at IS NULL
