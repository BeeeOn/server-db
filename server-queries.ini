[beeeon]
gateways.create           = INSERT INTO beeeon.gateways (id, name, altitude, latitude, longitude, timezone) VALUES ($1::bigint, $2::varchar, $3::integer, $4::double precision, $5::double precision, $6::varchar(64))
gateways.fetch.by.id      = SELECT g.id AS id, g.name AS name, g.altitude AS altitude, g.latitude AS latitude, g.longitude AS longitude, g.timezone AS timezone, extract(epoch from s.at)::bigint AS last_changed, s.version AS version, host(s.ip)::varchar(45) AS ip FROM beeeon.gateways AS g LEFT JOIN beeeon.gateways_status AS s ON g.id = s.gateway_id WHERE g.id = $1::bigint AND (s.at IS NULL OR s.at = beeeon.gateways_status_most_recent(g.id)) LIMIT 1
gateways.update           = UPDATE beeeon.gateways SET name = $2::varchar, altitude = $3::integer, latitude = $4::double precision, longitude = $5::double precision, timezone = $6::varchar(64) WHERE id = $1::bigint
gateways.fetch.accessible = SELECT DISTINCT g.id AS id, g.name AS name, g.altitude AS altitude, g.latitude AS latitude, g.longitude AS longitude, g.timezone AS timezone, extract(epoch from s.at)::bigint AS last_changed, s.version AS version, host(s.ip)::varchar(45) AS ip FROM beeeon.gateways AS g JOIN beeeon.roles_in_gateway AS r ON g.id = r.gateway_id JOIN beeeon.verified_identities AS v ON v.identity_id = r.identity_id LEFT JOIN beeeon.gateways_status AS s ON s.gateway_id = g.id WHERE v.user_id = $1::uuid AND (s.at IS NULL OR s.at = beeeon.gateways_status_most_recent(g.id))
gateways_status.insert    = WITH input AS (SELECT $1::bigint AS gateway_id, beeeon.as_utc_timestamp($2) AS at, $3::varchar(40) AS version, $4::inet AS ip), status AS (SELECT count(*) > 0 AS same FROM beeeon.gateways_status AS s, input WHERE s.gateway_id = input.gateway_id AND s.version = input.version AND s.ip = input.ip AND s.at = beeeon.gateways_status_most_recent(input.gateway_id)) INSERT INTO beeeon.gateways_status (gateway_id, at, version, ip) SELECT input.gateway_id, input.at, input.version, input.ip FROM input, status WHERE NOT status.same

locations.create          = INSERT INTO beeeon.locations (id, name, gateway_id) VALUES ($1::uuid, $2::varchar, $3::bigint)
locations.fetch.by.id     = SELECT * FROM beeeon.locations_by_id($1::uuid)
locations.fetch.by.gateway_id = SELECT * FROM beeeon.locations_by_gateway($1::bigint)
locations.fetch.by.id.and.gateway_id = SELECT * FROM beeeon.locations_by_id_and_gateway($1::uuid, $2::bigint)
locations.update          = SELECT beeeon.locations_update($1::uuid, $2::varchar)
locations.remove          = SELECT beeeon.locations_remove($1::uuid)

users.create              = SELECT beeeon.users_insert ($1::uuid, $2::varchar, $3::varchar, $4::varchar)
users.fetch.by.id         = SELECT * FROM beeeon.users_by_id($1::uuid)

fcm_tokens.create           = SELECT beeeon.fcm_tokens_insert($1::varchar, $2::uuid)
fcm_tokens.remove           = SELECT beeeon.fcm_tokens_remove($1::varchar)
fcm_tokens.replace          = SELECT beeeon.fcm_tokens_replace($1::varchar, $2::varchar)
fcm_tokens.fetch.by.id      = SELECT * FROM beeeon.fcm_tokens_by_id($1::varchar)
fcm_tokens.fetch.by.user.id = SELECT * FROM beeeon.fcm_tokens_by_user_id($1::uuid)
fcm_recipients.by_gateway   = SELECT * FROM beeeon.fcm_recipients_by_gateway($1::bigint)

identities.create         = SELECT beeeon.identities_insert($1::uuid, $2::varchar)
identities.fetch.by.id    = SELECT * FROM beeeon.identities_by_id($1::uuid)
identities.fetch.by.email = SELECT * FROM beeeon.identities_by_email($1::varchar)
identities.remove         = SELECT beeeon.identities_remove($1::uuid)

verified_identities.create         = SELECT beeeon.verified_identities_insert($1::uuid, $2::uuid , $3::uuid , $4::varchar, $5::varchar, $6::varchar)
verified_identities.fetch.by.id    = SELECT * FROM beeeon.verified_identities_by_id($1::uuid)
verified_identities.fetch.by.email.and.provider = SELECT * FROM beeeon.verified_identities_by_email_and_provider($1::varchar, $2::varchar)
verified_identities.fetch.by.email = SELECT * FROM beeeon.verified_identities_by_email($1::varchar)
verified_identities.fetch.by.user  = SELECT * FROM beeeon.verified_identities_by_user($1::uuid)
verified_identities.update         = SELECT beeeon.verified_identities_update($1::uuid, $2::varchar, $3::varchar)
verified_identities.remove         = SELECT beeeon.verified_identities_remove($1::uuid)

roles_in_gateway.create              = SELECT beeeon.roles_in_gateway_insert($1::uuid, $2::bigint, $3::uuid, $4::integer, $5::bigint)
roles_in_gateway.update              = SELECT beeeon.roles_in_gateway_update($1::uuid, $2::integer)
roles_in_gateway.fetch.by.id         = SELECT * FROM beeeon.roles_in_gateway_by_id($1::uuid)
roles_in_gateway.fetch.by.gateway_id = SELECT * FROM beeeon.roles_in_gateway_by_gateway($1::bigint)
roles_in_gateway.remove              = SELECT beeeon.roles_in_gateway_remove($1::uuid)
roles_in_gateway.remove.user         = SELECT beeeon.roles_in_gateway_remove_user($1::uuid, $2::bigint)
roles_in_gateway.remove.all          = SELECT beeeon.roles_in_gateway_remove_gateway_all($1::bigint)
roles_in_gateway.is.user             = SELECT beeeon.roles_in_gateway_is_user($1::uuid, $2::uuid)
roles_in_gateway.is.registered       = SELECT beeeon.roles_in_gateway_is_registered($1::bigint)
roles_in_gateway.has.only.given.level.except = SELECT beeeon.roles_in_gateway_has_only_given_level_except($1::integer, $2::bigint, $3::uuid)
roles_in_gateway.can.see.identity = SELECT beeeon.roles_in_gateway_can_see_identity($1::uuid, $2::uuid)
roles_in_gateway.can.see.verified_identity = SELECT beeeon.roles_in_gateway_can_see_verified_identity($1::uuid, $2::uuid)
roles_in_gateway.fetch.access_level  = SELECT beeeon.roles_in_gateway_access_level($1::bigint, $2::uuid)
roles_in_gateway.fetch.accessible.gateways = SELECT * FROM beeeon.roles_in_gateway_accessible_gateways($1::integer, $2::uuid)

legacy_roles_in_gateway.fetch.by.id = SELECT * FROM beeeon.legacy_roles_in_gateway_by_id($1::uuid)
legacy_roles_in_gateway.fetch.by.gateway_id = SELECT * FROM beeeon.legacy_roles_in_gateway_by_gateway($1::bigint)

legacy_gateways.fetch.by.id = SELECT * FROM beeeon.legacy_gateways_by_id($1::uuid, $2::bigint)
legacy_gateways.fetch.accessible = SELECT * FROM beeeon.legacy_gateways_accessible($1::uuid)

devices.create             = SELECT beeeon.devices_insert($1::numeric, $2::bigint, $3::uuid, $4::varchar, $5::smallint, $6::integer, $7::smallint, $8::smallint, $9::bigint, $10::bigint, $11::bigint)
devices.update             = SELECT beeeon.devices_update($8::numeric, $9::bigint, $1::uuid, $2::varchar, $3::smallint, $4::integer, $5::smallint, $6::smallint, $7::bigint)
devices.fetch.from.gateway = SELECT * FROM beeeon.devices_by_id_and_gateway($1::numeric, $2::bigint)
devices.fetch.active.by.gateway   = SELECT * FROM beeeon.devices_active_by_gateway($1::bigint)
devices.fetch.inactive.by.gateway = SELECT * FROM beeeon.devices_inactive_by_gateway($1::bigint)
devices.fetch.active.by.gateway.with.prefix = SELECT * FROM beeeon.devices_active_by_idrange_and_gateway($1::bigint, $2::numeric(20, 0), $3::numeric(20, 0))

devices_properties.insert  = SELECT beeeon.device_properties_insert($1::numeric, $2::bigint, $3::smallint, $4::text, $5::text)
devices_properties.update  = SELECT beeeon.device_properties_update($3::numeric, $4::bigint, $5::smallint, $1::text, $2::text)
devices_properties.remove  = SELECT beeeon.device_properties_remove($1::numeric, $2::bigint, $3::smallint)
devices_properties.fetch   = SELECT * FROM beeeon.device_properties_by_key($1::numeric, $2::bigint, $3::smallint)
devices_properties.fetch.by.device = SELECT * FROM beeeon.device_properties_by_device($1::numeric, $2::bigint)

sensors_history.insert = SELECT beeeon.sensor_history_recent_insert($1::bigint, beeeon.to_device_id($2::numeric(20, 0)), $3::smallint, beeeon.as_utc_timestamp_us($4), $5)
sensors_history.fetch = SELECT extract(epoch FROM at)::bigint, value FROM beeeon.sensor_history_last WHERE gateway_id = $1 AND device_id = beeeon.to_device_id($2) AND module_id = $3
sensors_history.fetch.huge.interval = SELECT * FROM beeeon.sensor_history_recent_aggregate($1::bigint, $2::numeric(20, 0), $3::smallint, $4::bigint, $5::bigint, $6::bigint)

controls_fsm.insert_request = INSERT INTO beeeon.controls_fsm (gateway_id, device_id, module_id, value, requested_at, accepted_at, finished_at, failed, originator_user_id) VALUES ($1::bigint, beeeon.to_device_id($2::numeric(20, 0)), $3::smallint, $4::real, beeeon.as_utc_timestamp_us($5), beeeon.as_utc_timestamp_us($6), beeeon.as_utc_timestamp_us($7), $8::boolean, $9::uuid)
controls_fsm.update_request = UPDATE beeeon.controls_fsm SET accepted_at = beeeon.as_utc_timestamp_us($1), finished_at = beeeon.as_utc_timestamp_us($2), failed = $3::boolean WHERE gateway_id = $4::bigint AND device_id = beeeon.to_device_id($5::numeric(20, 0)) AND module_id = $6 AND requested_at = beeeon.as_utc_timestamp_us($7)
controls_fsm.fetch_last = SELECT f.value as requested_value, (extract(epoch from f.requested_at) * 1000000)::bigint AS requested_at, (extract(epoch from f.accepted_at) * 1000000)::bigint AS accepted_at, (extract(epoch from f.finished_at) * 1000000)::bigint AS finished_at, f.failed AS failed, f.originator_user_id AS originator_user_id, (extract(epoch from r.at) * 1000000)::bigint AS recent_at, r.value AS recent_value FROM beeeon.controls_fsm_last f FULL OUTER JOIN beeeon.sensor_history_last r ON f.gateway_id = r.gateway_id AND f.device_id = r.device_id AND f.module_id = r.module_id WHERE f.gateway_id = $1::bigint AND f.device_id = beeeon.to_device_id($2) AND f.module_id = $3::smallint
controls_fsm.cancel_unfinished = UPDATE beeeon.controls_fsm SET finished_at = NOW(), failed = true WHERE finished_at IS NULL
